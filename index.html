<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Duo - Multiplayer Mystery Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ecf0f1;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(44, 62, 80, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(236, 240, 241, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #bdc3c7;
            font-style: italic;
        }

        .multiplayer-setup {
            background: rgba(52, 73, 94, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .room-input {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .room-input input {
            padding: 12px;
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            background: rgba(44, 62, 80, 0.9);
            color: #ecf0f1;
            font-size: 1rem;
            min-width: 200px;
        }

        .room-input button {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .room-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .connection-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        .connection-status.connected {
            background: rgba(39, 174, 96, 0.3);
            border: 1px solid #27ae60;
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .player-card {
            background: rgba(44, 62, 80, 0.8);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active-turn {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
            animation: pulse 2s infinite;
        }

        .player-name {
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 5px;
        }

        .player-status {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .game-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .main-content {
            background: rgba(52, 73, 94, 0.6);
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #f39c12;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .suspects-section, .chat-section {
            background: rgba(52, 73, 94, 0.8);
            padding: 20px;
            border-radius: 15px;
        }

        .chat-section {
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            font-size: 1.3rem;
            color: #3498db;
            margin-bottom: 15px;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: rgba(44, 62, 80, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(52, 73, 94, 0.8);
            border-left: 3px solid #3498db;
        }

        .message.system {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
            font-style: italic;
        }

        .message.player1 {
            border-left-color: #e74c3c;
        }

        .message.player2 {
            border-left-color: #27ae60;
        }

        .message-sender {
            font-weight: bold;
            color: #f39c12;
            font-size: 0.9rem;
        }

        .message-text {
            color: #ecf0f1;
            margin-top: 3px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            background: rgba(44, 62, 80, 0.9);
            color: #ecf0f1;
            font-size: 0.9rem;
        }

        .chat-send {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .case-title {
            font-size: 2rem;
            color: #f39c12;
            margin-bottom: 15px;
            text-align: center;
        }

        .case-description {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #ecf0f1;
        }

        .turn-indicator {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .turn-indicator.waiting {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .clues-section {
            background: rgba(39, 174, 96, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .clues-title {
            font-size: 1.3rem;
            color: #27ae60;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .clue-item {
            background: rgba(44, 62, 80, 0.8);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #3498db;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clue-item:hover {
            background: rgba(52, 73, 94, 1);
            transform: translateX(5px);
        }

        .clue-item.revealed {
            border-left-color: #27ae60;
            background: rgba(39, 174, 96, 0.2);
        }

        .clue-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suspects-title {
            font-size: 1.3rem;
            color: #e74c3c;
            margin-bottom: 15px;
            text-align: center;
        }

        .suspect {
            background: rgba(44, 62, 80, 0.9);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suspect:hover {
            border-color: #f39c12;
            transform: scale(1.02);
        }

        .suspect.selected {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        .suspect.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suspect-name {
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 5px;
        }

        .suspect-info {
            font-size: 0.9rem;
            color: #bdc3c7;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }

        .control-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .case-selector {
            margin-bottom: 30px;
            text-align: center;
        }

        .case-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .case-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .case-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .case-btn.active {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .case-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .result-section {
            background: rgba(39, 174, 96, 0.2);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-section.wrong {
            background: rgba(231, 76, 60, 0.2);
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(39, 174, 96, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .sync-indicator.syncing {
            background: rgba(243, 156, 18, 0.9);
        }

        @media (max-width: 1024px) {
            .game-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .player-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .room-input {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncIndicator">🔄 Synced</div>

    <div class="game-container">
        <div class="header">
            <h1>🔍 Detective Duo - Multiplayer 🔍</h1>
            <p>Solve mysteries together in real-time</p>
        </div>

        <div class="multiplayer-setup">
            <div class="room-input">
                <input type="text" id="roomCode" placeholder="Enter room code (e.g. MYSTERY123)" maxlength="20">
                <input type="text" id="playerName" placeholder="Your name" maxlength="15">
                <button onclick="joinRoom()">Join Room</button>
                <button onclick="createRoom()">Create New Room</button>
            </div>
            
            <div class="connection-status disconnected" id="connectionStatus">
                🔴 Not connected - Create or join a room to play together
            </div>

            <div class="player-info" id="playerInfo" style="display: none;">
                <div class="player-card" id="player1Card">
                    <div class="player-name" id="player1Name">Player 1</div>
                    <div class="player-status">Waiting...</div>
                </div>
                <div class="player-card" id="player2Card">
                    <div class="player-name" id="player2Name">Player 2</div>
                    <div class="player-status">Waiting...</div>
                </div>
            </div>
        </div>

        <div id="gameContent" style="display: none;">
            <div class="turn-indicator" id="turnIndicator">
                🎯 Waiting for players to connect...
            </div>

            <div class="case-selector">
                <div class="case-buttons">
                    <button class="case-btn active" onclick="selectDifficulty('easy')">Beginner Cases</button>
                    <button class="case-btn" onclick="selectDifficulty('medium')">Intermediate Cases</button>
                    <button class="case-btn" onclick="selectDifficulty('hard')">Expert Cases</button>
                </div>
            </div>

            <div class="game-layout">
                <div class="main-content">
                    <div class="case-title" id="caseTitle">Select a difficulty to begin</div>
                    <div class="case-description" id="caseDescription">
                        Choose your difficulty level above to start solving mysteries together!
                    </div>

                    <div class="clues-section" id="cluesSection" style="display: none;">
                        <div class="clues-title">
                            🔎 Evidence & Clues
                            <span style="font-size: 0.9rem; color: #95a5a6;">(Take turns revealing)</span>
                        </div>
                        <div id="cluesList"></div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="suspects-section">
                        <div class="suspects-title">🎭 Suspects</div>
                        <div id="suspectsList">
                            <p style="text-align: center; color: #95a5a6; font-style: italic;">
                                Start a case to see suspects
                            </p>
                        </div>
                    </div>

                    <div class="chat-section">
                        <div class="chat-header">💬 Detective Chat</div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="message system">
                                <div class="message-text">Welcome detectives! Use this chat to discuss clues and theories.</div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" id="chatInput" placeholder="Share your thoughts..." maxlength="200">
                            <button class="chat-send" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="game-controls">
                <button class="control-btn" onclick="startNewCase()" id="newCaseBtn">Start New Case</button>
                <button class="control-btn" onclick="revealClue()" id="revealClueBtn" disabled>Reveal Next Clue</button>
                <button class="control-btn" onclick="makeAccusation()" id="accuseBtn" disabled>Make Accusation</button>
            </div>

            <div class="result-section" id="resultSection">
                <h2 id="resultTitle">Case Solved!</h2>
                <p id="resultText"></p>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            roomCode: '',
            players: {},
            currentCase: null,
            difficulty: 'easy',
            revealedClues: 0,
            selectedSuspects: {},
            currentTurn: 1,
            gamePhase: 'setup', // setup, playing, accusation, finished
            isHost: false
        };

        let localPlayer = {
            id: null,
            name: '',
            playerNumber: null
        };

        // Simulated multiplayer (in a real app, you'd use WebSockets or Firebase)
        let gameData = {};
        let syncInterval;

        const mysteries = {
            easy: [
                {
                    title: "The Missing Cookies",
                    description: "Mrs. Johnson's famous chocolate chip cookies have disappeared from the kitchen counter. The jar was full this morning, but now it's completely empty. Three people were home today, and each has an alibi. Who took the cookies?",
                    clues: [
                        "Crumbs were found leading to Tommy's room",
                        "Sarah was at school all day according to attendance records", 
                        "Dad's coffee mug had chocolate smudges on it",
                        "Tommy claimed he was playing video games all afternoon",
                        "The cookie jar was moved from its usual spot",
                        "Mom found an empty milk glass in Dad's office"
                    ],
                    suspects: [
                        { name: "Tommy", info: "Age 12, loves cookies, was home from school with a cold" },
                        { name: "Sarah", info: "Age 16, on a diet, claims she was at school" },
                        { name: "Dad", info: "Works from home, always snacks while working" }
                    ],
                    solution: "Dad",
                    explanation: "Dad took the cookies! The chocolate smudges on his coffee mug, the empty milk glass in his office, and the moved cookie jar all point to him sneaking cookies while working."
                },
                {
                    title: "The Broken Vase",
                    description: "A valuable family vase has been shattered in the living room. It happened sometime between 2 PM and 4 PM when everyone was home. Each family member claims they weren't near the living room during that time.",
                    clues: [
                        "Soccer ball found under the couch nearby",
                        "Jenny's homework was spread on the living room table",
                        "The TV remote was on the floor next to the vase pieces",
                        "Mom was cooking in the kitchen, which faces away from the living room",
                        "Dad was taking a nap upstairs during that time",
                        "Fresh grass stains on the soccer ball"
                    ],
                    suspects: [
                        { name: "Jenny", info: "Age 14, doing homework, claims she stayed at the table" },
                        { name: "Mike", info: "Age 10, was playing soccer outside earlier" }, 
                        { name: "Dad", info: "Was napping upstairs, very tired from work" }
                    ],
                    solution: "Mike",
                    explanation: "Mike broke the vase! He brought his soccer ball inside and accidentally knocked over the vase while playing. The grass stains prove he was playing outside earlier, and the ball's location gives him away."
                }
            ],
            medium: [
                {
                    title: "The Office Sabotage",
                    description: "Someone has been deleting important files from the company server every Friday night. The IT logs show the deletions happen between 7 PM and 9 PM. Security footage shows three employees with access during those times over the past month.",
                    clues: [
                        "The deleted files were all related to the marketing department",
                        "Alex's keycard was used to enter the building at 7:15 PM last Friday",
                        "Lisa's computer was logged in remotely during the deletion time",
                        "Jordan was seen leaving the office at 6:30 PM by security",
                        "The marketing budget was recently cut, affecting bonuses",
                        "Alex and Lisa are both up for the same promotion",
                        "Jordan's project was cancelled due to budget constraints"
                    ],
                    suspects: [
                        { name: "Alex", info: "Marketing coordinator, ambitious, needs the promotion for financial reasons" },
                        { name: "Lisa", info: "Senior marketing analyst, works late often, tech-savvy" },
                        { name: "Jordan", info: "Project manager, bitter about recent layoffs and budget cuts" }
                    ],
                    solution: "Jordan",
                    explanation: "Jordan is the saboteur! Despite leaving at 6:30 PM, they used their remote access to delete files. The cancelled project and budget cuts gave them motive for revenge against the marketing department."
                }
            ],
            hard: [
                {
                    title: "The Locked Room Murder",
                    description: "Renowned detective novelist Edgar Blackwood was found dead in his locked study. The door was locked from the inside, windows were sealed shut, and no weapon was found. Three people had access to the house that evening, each with their own key and alibi.",
                    clues: [
                        "Blackwood's latest manuscript revealed a character based on someone he knew",
                        "The victim's coffee cup contained traces of a rare poison",
                        "Victoria's purse contained the same type of poison used in her research",
                        "Marcus's fingerprints were on the coffee pot in the kitchen",
                        "Helena was seen arguing with Blackwood about money two days prior",
                        "The study's ventilation system had been recently tampered with",
                        "A small hole was drilled through the wall behind a bookshelf",
                        "Victoria had access to the house's original blueprints"
                    ],
                    suspects: [
                        { name: "Victoria", info: "Forensic scientist, Blackwood's research partner, knew his habits well" },
                        { name: "Marcus", info: "Blackwood's nephew and heir, deeply in debt" },
                        { name: "Helena", info: "Blackwood's ex-wife, bitter about the divorce settlement" }
                    ],
                    solution: "Victoria",
                    explanation: "Victoria murdered Blackwood! She used her scientific knowledge to create a delayed poison delivery system through the ventilation. The hole behind the bookshelf allowed her to introduce the poison remotely, creating the perfect locked room murder."
                }
            ]
        };

        // Initialize
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name first!');
                return;
            }

            const roomCode = 'ROOM' + Math.random().toString(36).substr(2, 6).toUpperCase();
            document.getElementById('roomCode').value = roomCode;
            
            gameState.isHost = true;
            joinRoom();
        }

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const playerName = document.getElementById('playerName').value.trim();

            if (!roomCode || !playerName) {
                alert('Please enter both room code and your name!');
                return;
            }

            // Initialize or join room
            if (!gameData[roomCode]) {
                gameData[roomCode] = {
                    players: {},
                    gameState: {
                        roomCode: roomCode,
                        difficulty: 'easy',
                        currentCase: null,
                        revealedClues: 0,
                        selectedSuspects: {},
                        currentTurn: 1,
                        gamePhase: 'setup',
                        messages: []
                    }
                };
            }

            // Add player
            localPlayer.id = 'player_' + Date.now();
            localPlayer.name = playerName;
            
            const existingPlayerCount = Object.keys(gameData[roomCode].players).length;
            if (existingPlayerCount >= 2) {
                alert('Room is full! Only 2 players allowed.');
                return;
            }

            localPlayer.playerNumber = existingPlayerCount + 1;
            gameData[roomCode].players[localPlayer.id] = {
                name: playerName,
                playerNumber: localPlayer.playerNumber,
                connected: true
            };

            gameState = {...gameData[roomCode].gameState};
            gameState.roomCode = roomCode;

            // Update UI
            document.getElementById('connectionStatus').textContent = `🟢 Connected to room: ${roomCode}`;
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('playerInfo').style.display = 'flex';
            document.getElementById('gameContent').style.display = 'block';

            updatePlayerInfo();
            updateTurnIndicator();
            loadMessages();
            
            addSystemMessage(`${playerName} joined the room`);

            // Start sync
            startSync();
        }

        function startSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncGameState, 1000);
        }

        function syncGameState() {
            if (!gameState.roomCode) return;

            // Update local changes to shared data
            if (gameData[gameState.roomCode]) {
                gameData[gameState.roomCode].gameState = {...gameState};
                gameData[gameState.roomCode].players[localPlayer.id].connected = true;
            }

            // Pull changes from shared data
            const sharedState = gameData[gameState.roomCode]?.gameState;
            if (sharedState) {
                const oldRevealedClues = gameState.revealedClues;
                const oldGamePhase = gameState.gamePhase;
                
                gameState = {...sharedState};
                
                // Update UI if state changed
                if (oldRevealedClues !== gameState.revealedClues) {
                    updateCluesUI();
                }
                if (oldGamePhase !== gameState.gamePhase) {
                    updateGamePhaseUI();
                }
                
                updatePlayerInfo();
                updateTurnIndicator();
                updateButtonStates();
                loadMessages();
            }

            // Update sync indicator
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = '✅ Synced';
            indicator.className = 'sync-indicator';
        }

        function updatePlayerInfo() {
            if (!gameData[gameState.roomCode]) return;

            const players = gameData[gameState.roomCode].players;
            const playerArray = Object.values(players);

            for (let i = 1; i <= 2; i++) {
                const player = playerArray.find(p => p.playerNumber === i);
                const nameElement = document.getElementById(`player${i}Name`);
                const cardElement = document.getElementById(`player${i}Card`);
                
                if (player) {
                    nameElement.textContent = player.name;
                    cardElement.querySelector('.player-status').textContent = 
                        player.connected ? 'Connected' : 'Disconnected';
                } else {
                    nameElement.textContent = `Player ${i}`;
                    cardElement.querySelector('.player-status').textContent = 'Waiting to join...';
                }

                // Highlight current turn
                if (gameState.currentTurn === i && gameState.gamePhase === 'playing') {
                    cardElement.classList.add('active-turn');
                } else {
                    cardElement.classList.remove('active-turn');
                }
            }
        }

        function updateTurnIndicator() {
            const indicator = document.getElementById('turnIndicator');
            const playerCount = Object.keys(gameData[gameState.roomCode]?.players || {}).length;
            
            if (playerCount < 2) {
                indicator.textContent = '⏳ Waiting for second player to join...';
                indicator.className = 'turn-indicator waiting';
            } else if (gameState.gamePhase === 'setup') {
                indicator.textContent = '🎯 Both players connected! Start a new case to begin.';
                indicator.className = 'turn-indicator';
            } else if (gameState.gamePhase === 'playing') {
                const currentPlayerName = getCurrentPlayerName();
                const isMyTurn = gameState.currentTurn === localPlayer.playerNumber;
                
                if (isMyTurn) {
                    indicator.textContent = `🎯 Your turn! Reveal a clue or select a suspect.`;
                    indicator.className = 'turn-indicator';
                } else {
                    indicator.textContent = `⏳ ${currentPlayerName}'s turn - waiting for their move...`;
                    indicator.className = 'turn-indicator waiting';
                }
            } else if (gameState.gamePhase === 'accusation') {
                indicator.textContent = '⚖️ Time for accusations! Both players select your suspects.';
                indicator.className = 'turn-indicator';
            } else if (gameState.gamePhase === 'finished') {
                indicator.textContent = '🎉 Case closed! Start a new case to continue playing.';
                indicator.className = 'turn-indicator';
            }
        }

        function getCurrentPlayerName() {
            if (!gameData[gameState.roomCode]) return 'Player';
            
            const players = Object.values(gameData[gameState.roomCode].players);
            const currentPlayer = players.find(p => p.playerNumber === gameState.currentTurn);
            return currentPlayer ? currentPlayer.name : 'Player';
        }

        function selectDifficulty(difficulty) {
            if (!canMakeMove()) return;
            
            gameState.difficulty = difficulty;
            document.querySelectorAll('.case-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('caseTitle').textContent = `${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Cases Selected`;
            document.getElementById('caseDescription').textContent = `Click "Start New Case" to begin a ${difficulty} mystery!`;
            
            addSystemMessage(`Difficulty set to ${difficulty}`);
            syncGameState();
        }

        function startNewCase() {
            if (!canMakeMove() || Object.keys(gameData[gameState.roomCode]?.players || {}).length < 2) {
                alert('Wait for both players to connect!');
                return;
            }

            const cases = mysteries[gameState.difficulty];
            gameState.currentCase = cases[Math.floor(Math.random() * cases.length)];
            gameState.gamePhase = 'playing';
            gameState.revealedClues = 0;
            gameState.selectedSuspects = {};
            gameState.currentTurn = 1;
            
            document.getElementById('caseTitle').textContent = gameState.currentCase.title;
            document.getElementById('caseDescription').textContent = gameState.currentCase.description;
            document.getElementById('cluesSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('show', 'wrong');
            
            setupClues();
            setupSuspects();
            updateButtonStates();
            updateTurnIndicator();
            
            addSystemMessage(`New case started: ${gameState.currentCase.title}`);
            syncGameState();
        }

        function setupClues() {
            const cluesList = document.getElementById('cluesList');
            cluesList.innerHTML = '';
            
            gameState.currentCase.clues.forEach((clue, index) => {
                const clueDiv = document.createElement('div');
                clueDiv.className = 'clue-item';
                clueDiv.innerHTML = `<strong>Clue ${index + 1}:</strong> <span class="clue-text">Click to reveal</span>`;
                clueDiv.onclick = () => revealSpecificClue(index);
                cluesList.appendChild(clueDiv);
            });
            
            updateCluesUI();
        }

        function setupSuspects() {
            const suspectsList = document.getElementById('suspectsList');
            suspectsList.innerHTML = '';
            
            gameState.currentCase.suspects.forEach((suspect, index) => {
                const suspectDiv = document.createElement('div');
                suspectDiv.className = 'suspect';
                suspectDiv.innerHTML = `
                    <div class="suspect-name">${suspect.name}</div>
                    <div class="suspect-info">${suspect.info}</div>
                `;
                suspectDiv.onclick = () => selectSuspect(suspect.name, suspectDiv);
                suspectsList.appendChild(suspectDiv);
            });
            
            updateSuspectsUI();
        }

        function revealClue() {
            if (!canMakeMove() || gameState.gamePhase !== 'playing') return;
            
            if (gameState.revealedClues < gameState.currentCase.clues.length) {
                revealSpecificClue(gameState.revealedClues);
                nextTurn();
            }
        }

        function revealSpecificClue(index) {
            if (!canMakeMove() || gameState.gamePhase !== 'playing') return;
            if (index !== gameState.revealedClues) return; // Must reveal in order
            
            gameState.revealedClues = Math.max(gameState.revealedClues, index + 1);
            
            const currentPlayerName = getCurrentPlayerName();
            addSystemMessage(`${currentPlayerName} revealed: "${gameState.currentCase.clues[index]}"`);
            
            updateCluesUI();
            updateButtonStates();
            syncGameState();
            
            nextTurn();
        }

        function updateCluesUI() {
            const clueItems = document.querySelectorAll('.clue-item');
            clueItems.forEach((clueItem, index) => {
                if (index < gameState.revealedClues) {
                    clueItem.classList.add('revealed');
                    clueItem.querySelector('.clue-text').textContent = gameState.currentCase.clues[index];
                }
                
                // Only allow revealing next clue in sequence
                if (index === gameState.revealedClues && canMakeMove() && gameState.gamePhase === 'playing') {
                    clueItem.classList.remove('disabled');
                } else if (index > gameState.revealedClues) {
                    clueItem.classList.add('disabled');
                }
            });
        }

        function selectSuspect(name, element) {
            if (gameState.gamePhase === 'playing') {
                // During playing phase, only current player can select
                if (!canMakeMove()) return;
                
                gameState.selectedSuspects[localPlayer.playerNumber] = name;
                addSystemMessage(`${localPlayer.name} suspects ${name}`);
                
                // If all clues revealed, move to accusation phase
                if (gameState.revealedClues >= gameState.currentCase.clues.length) {
                    gameState.gamePhase = 'accusation';
                    addSystemMessage('All clues revealed! Time for final accusations.');
                }
                
                nextTurn();
            } else if (gameState.gamePhase === 'accusation') {
                // Both players can select during accusation phase
                gameState.selectedSuspects[localPlayer.playerNumber] = name;
                addSystemMessage(`${localPlayer.name} accuses ${name}`);
            } else {
                return;
            }
            
            updateSuspectsUI();
            updateButtonStates();
            updateTurnIndicator();
            syncGameState();
        }

        function updateSuspectsUI() {
            const suspects = document.querySelectorAll('.suspect');
            suspects.forEach(suspectDiv => {
                suspectDiv.classList.remove('selected');
                
                const suspectName = suspectDiv.querySelector('.suspect-name').textContent;
                
                // Show if this player selected this suspect
                if (gameState.selectedSuspects[localPlayer.playerNumber] === suspectName) {
                    suspectDiv.classList.add('selected');
                }
                
                // Disable if not player's turn (during playing phase)
                if (gameState.gamePhase === 'playing' && !canMakeMove()) {
                    suspectDiv.classList.add('disabled');
                } else {
                    suspectDiv.classList.remove('disabled');
                }
            });
        }

        function makeAccusation() {
            if (gameState.gamePhase !== 'accusation') {
                alert('Reveal all clues first!');
                return;
            }

            if (Object.keys(gameState.selectedSuspects).length < 2) {
                alert('Both players must select a suspect!');
                return;
            }

            // Process results
            gameState.gamePhase = 'finished';
            
            const player1Suspect = gameState.selectedSuspects[1];
            const player2Suspect = gameState.selectedSuspects[2];
            const solution = gameState.currentCase.solution;
            
            const player1Correct = player1Suspect === solution;
            const player2Correct = player2Suspect === solution;
            
            let resultTitle, resultText, resultClass;
            
            if (player1Correct && player2Correct) {
                resultTitle = '🎉 Perfect Teamwork! 🎉';
                resultText = `Both detectives correctly identified <strong>${solution}</strong>!<br><br><strong>Solution:</strong> ${gameState.currentCase.explanation}`;
                resultClass = '';
            } else if (player1Correct || player2Correct) {
                const correctPlayer = player1Correct ? getPlayerName(1) : getPlayerName(2);
                resultTitle = '🎯 Partial Success!';
                resultText = `${correctPlayer} correctly identified <strong>${solution}</strong>!<br><br><strong>Solution:</strong> ${gameState.currentCase.explanation}`;
                resultClass = '';
            } else {
                resultTitle = '❌ Case Unsolved ❌';
                resultText = `Neither detective got it right! The real culprit was <strong>${solution}</strong>.<br><br><strong>Solution:</strong> ${gameState.currentCase.explanation}`;
                resultClass = 'wrong';
            }
            
            document.getElementById('resultTitle').innerHTML = resultTitle;
            document.getElementById('resultText').innerHTML = resultText;
            document.getElementById('resultSection').className = `result-section show ${resultClass}`;
            
            addSystemMessage(`Case finished! Solution: ${solution}`);
            
            updateButtonStates();
            updateTurnIndicator();
            syncGameState();
        }

        function getPlayerName(playerNumber) {
            if (!gameData[gameState.roomCode]) return `Player ${playerNumber}`;
            
            const players = Object.values(gameData[gameState.roomCode].players);
            const player = players.find(p => p.playerNumber === playerNumber);
            return player ? player.name : `Player ${playerNumber}`;
        }

        function nextTurn() {
            if (gameState.gamePhase === 'playing') {
                gameState.currentTurn = gameState.currentTurn === 1 ? 2 : 1;
                updateTurnIndicator();
            }
        }

        function canMakeMove() {
            return gameState.currentTurn === localPlayer.playerNumber;
        }

        function updateButtonStates() {
            const hasCase = gameState.currentCase !== null;
            const isPlaying = gameState.gamePhase === 'playing';
            const isAccusation = gameState.gamePhase === 'accusation';
            const hasMoreClues = hasCase && gameState.revealedClues < gameState.currentCase.clues.length;
            const bothPlayersSelected = Object.keys(gameState.selectedSuspects).length >= 2;
            const myTurn = canMakeMove();
            const playerCount = Object.keys(gameData[gameState.roomCode]?.players || {}).length;
            
            // Difficulty buttons
            document.querySelectorAll('.case-btn').forEach(btn => {
                btn.disabled = hasCase && isPlaying;
            });
            
            // New case button
            document.getElementById('newCaseBtn').disabled = playerCount < 2;
            
            // Reveal clue button
            const revealBtn = document.getElementById('revealClueBtn');
            revealBtn.disabled = !hasCase || !isPlaying || !hasMoreClues || !myTurn;
            if (hasCase) {
                revealBtn.textContent = `Reveal Next Clue (${gameState.revealedClues}/${gameState.currentCase.clues.length})`;
            }
            
            // Accusation button
            document.getElementById('accuseBtn').disabled = !isAccusation || !bothPlayersSelected;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !gameState.roomCode) return;
            
            const messageObj = {
                id: Date.now(),
                sender: localPlayer.name,
                playerNumber: localPlayer.playerNumber,
                text: message,
                timestamp: new Date().toLocaleTimeString()
            };
            
            gameState.messages = gameState.messages || [];
            gameState.messages.push(messageObj);
            
            input.value = '';
            loadMessages();
            syncGameState();
        }

        function addSystemMessage(text) {
            const messageObj = {
                id: Date.now(),
                sender: 'System',
                playerNumber: 0,
                text: text,
                timestamp: new Date().toLocaleTimeString()
            };
            
            gameState.messages = gameState.messages || [];
            gameState.messages.push(messageObj);
            
            loadMessages();
        }

        function loadMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            const messages = gameState.messages || [];
            
            // Only show recent messages to avoid clutter
            const recentMessages = messages.slice(-20);
            
            messagesContainer.innerHTML = recentMessages.map(msg => {
                let messageClass = 'message';
                if (msg.playerNumber === 0) messageClass += ' system';
                else if (msg.playerNumber === 1) messageClass += ' player1';
                else if (msg.playerNumber === 2) messageClass += ' player2';
                
                return `
                    <div class="${messageClass}">
                        ${msg.playerNumber > 0 ? `<div class="message-sender">${msg.sender}</div>` : ''}
                        <div class="message-text">${msg.text}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateGamePhaseUI() {
            updateButtonStates();
            updateTurnIndicator();
            updateSuspectsUI();
            updateCluesUI();
        }

        // Initialize
        updateButtonStates();
    </script>
</body>
</html>
